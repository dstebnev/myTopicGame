<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Моя тема</title>
  <style>
    :root {
      --bg: #1f1f1f;
      --panel: #2b3282; /* глубокий синий */
      --panel-border: #e8ecff;
      --white: #ffffff;
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: var(--bg);
      color: var(--white);
      margin: 0;
      padding: 0;
    }

    /* Основная область для центрирования изображения */
    #stage {
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 48px 24px 160px; /* снизу пространство под таймеры и ответ */
    }

    #image-frame {
      max-width: min(90vw, 1100px);
      max-height: min(65vh, 700px);
      display: grid;
      place-items: center;
      border: 6px solid var(--panel-border);
      background: #111;
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
    }
    #current-image {
      width: 100%;
      height: auto;
      max-height: calc(min(65vh, 700px) - 12px);
      display: block;
    }

    /* HUD снизу: таймеры в углах и поле ответа по центру */
    #hud {
      position: fixed;
      left: 0; right: 0; bottom: 32px;
      pointer-events: none; /* элементы не кликабельны, просто отображение */
    }
    .timer-box {
      position: fixed;
      bottom: 32px;
      width: 120px;
      height: 120px;
      background: var(--panel);
      border-radius: 6px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.45);
      display: grid;
      place-items: center;
      font-weight: 800;
      font-size: 52px;
      color: var(--white);
    }
    #timer1 { left: 32px; }
    #timer2 { right: 32px; }

    .timer-box.active {
      outline: 6px solid var(--panel-border);
      outline-offset: 0;
    }
    .timer-box.penalty {
      filter: brightness(0.8) saturate(1.1);
    }

    #answer-bar {
      position: fixed;
      left: 50%; bottom: 32px; transform: translateX(-50%);
      min-width: min(70vw, 900px);
      min-height: 130px;
      max-width: 90vw;
      background: var(--panel);
      border: 6px solid var(--panel-border);
      border-radius: 6px;
      padding: 22px 24px;
      display: grid;
      place-items: center;
      box-shadow: 0 10px 24px rgba(0,0,0,0.45);
      pointer-events: none;
    }
    #answer {
      font-size: clamp(24px, 4.2vw, 48px);
      font-weight: 800;
      color: var(--white);
      letter-spacing: 1px;
    }

    /* Вспомогательная информация о раунде можно скрыть */
    #round-info {
      position: fixed;
      top: 16px; left: 50%; transform: translateX(-50%);
      font-size: 16px;
      color: #bfbfbf;
      opacity: 0.8;
    }
    /* Оверлей старта и обратный отсчёт */
    #start-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: grid;
      place-items: center;
      gap: 24px;
      z-index: 2000;
    }
    #start-btn {
      font-weight: 800;
      font-size: clamp(20px, 3.2vw, 32px);
      padding: 16px 32px;
      color: var(--white);
      background: var(--panel);
      border: 6px solid var(--panel-border);
      border-radius: 8px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.45);
      cursor: pointer;
    }
    #start-btn:active { transform: translateY(1px); }
    #countdown {
      display: none;
      font-weight: 900;
      font-size: clamp(64px, 14vw, 180px);
      color: var(--white);
      letter-spacing: 2px;
    }
  </style>
</head>
<body>
  <!-- <div id="round-info"></div> -->
  <main id="stage">
    <div id="image-frame">
      <img id="current-image" src="" alt="Картинка">
    </div>
  </main>
  <div id="start-overlay">
    <button id="start-btn" type="button">СТАРТ</button>
    <div id="countdown" aria-hidden="true"></div>
  </div>
  <div id="hud">
    <div id="timer1" class="timer-box">45</div>
    <div id="timer2" class="timer-box">45</div>
    <div id="answer-bar"><div id="answer"></div></div>
  </div>
  <!-- Регистрация раундов без сервера: подключаем JS-файлы с данными -->
  <script>
    // Глобальный реестр раундов. Внешние файлы могут вызвать addRound([...])
    window.__rounds = window.__rounds || [];
    window.addRound = function(images) { window.__rounds.push(images); };
  </script>
  <script src="round1/round.data.js"></script>
  <script>
    /*
      Данные раундов загружаются из JSON-файлов.
      См. файл `rounds.json` (манифест), где перечислены JSON каждого раунда.
      Каждый файл раунда может иметь формат:
        ["1.jpg", "2.jpg", ...]                                   // массив имён/путей
        или { "basePath": "round1", "images": ["1.jpg", ...] }   // объект с путём и массивом
      Ответ берётся из имени файла картинки (без расширения), где "_" и "-" заменяются пробелами.
    */
    // Массив раундов инициализируется из подключённых data.js файлов
    let rounds = window.__rounds || [];

    let currentRoundIndex = 0;
    let currentImageIndex = 0;
    let activePlayer = 1; // 1 или 2
    const initialTime = 45.0;
    const timers = [initialTime, initialTime]; // timers[0] для игрока 1, timers[1] для игрока 2

    let timerInterval = null;
    let answerShown = false;
    let gameEnded = false;
    let gameStarted = false;

    const timerElems = [document.getElementById('timer1'), document.getElementById('timer2')];
    const currentImageElem = document.getElementById('current-image');
    const answerElem = document.getElementById('answer');
    // const roundInfoElem = document.getElementById('round-info');

    /**
     * Проигрывает звуковой сигнал. Положительный звук имеет более высокую частоту,
     * отрицательный — более низкую. Этот способ не требует внешних аудиофайлов.
     */
    function playBeep(type) {
      const context = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = context.createOscillator();
      const gainNode = context.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(context.destination);
      oscillator.type = 'sine';
      if (type === 'positive') {
        oscillator.frequency.value = 880; // Гц
      } else {
        oscillator.frequency.value = 220; // Гц
      }
      gainNode.gain.setValueAtTime(0.2, context.currentTime);
      oscillator.start();
      oscillator.stop(context.currentTime + 0.25);
    }

    // Запустить игру
    function startGame() {
      timers[0] = initialTime;
      timers[1] = initialTime;
      activePlayer = 1;
      currentRoundIndex = 0;
      currentImageIndex = 0;
      gameEnded = false;
      gameStarted = true;
      updateRoundInfo();
      loadCurrentImage();
      updateTimersDisplay();
      startTimer(activePlayer);
    }

    // Обновить информацию о раунде
    function updateRoundInfo() {
      if (currentRoundIndex < rounds.length) {
        const round = rounds[currentRoundIndex];
        // roundInfoElem.textContent = `Раунд ${currentRoundIndex + 1}/${rounds.length}` +
        //   ` – Картинка ${currentImageIndex + 1}/${round.length}`;
      }
    }

    // Запуск таймера для активного игрока
    function startTimer(player) {
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        if (gameEnded) return;
        const idx = player - 1;
        timers[idx] -= 0.1;
        if (timers[idx] <= 0) {
          timers[idx] = 0;
          updateTimersDisplay();
          endGame();
        } else {
          updateTimersDisplay();
        }
      }, 100);
    }

    // Остановить таймер
    function stopTimer() {
      clearInterval(timerInterval);
    }

    // Отобразить значения таймеров и выделить активного игрока
    function updateTimersDisplay() {
      timerElems[0].textContent = `${Math.max(0, Math.ceil(timers[0]))}`;
      timerElems[1].textContent = `${Math.max(0, Math.ceil(timers[1]))}`;
      timerElems.forEach(elem => elem.classList.remove('active'));
      timerElems.forEach(elem => elem.classList.remove('penalty'));
      if (!gameEnded) {
        timerElems[activePlayer - 1].classList.add('active');
      }
    }

    // Загрузить текущую картинку
    function loadCurrentImage() {
      if (currentRoundIndex >= rounds.length) {
        endGame();
        return;
      }
      const round = rounds[currentRoundIndex];
      if (currentImageIndex >= round.length) {
        // Переходим к следующему раунду
        currentRoundIndex++;
        if (currentRoundIndex >= rounds.length) {
          endGame();
          return;
        } else {
          currentImageIndex = 0;
        }
      }
      updateRoundInfo();
      const imgPath = rounds[currentRoundIndex][currentImageIndex];
      currentImageElem.src = imgPath;
      answerElem.textContent = '';
    }

    // Получить ответ из имени файла
    function parseAnswer(path) {
      const fileName = path.substring(path.lastIndexOf('/') + 1, path.lastIndexOf('.'));
      return decodeURIComponent(fileName).replace(/[_-]/g, ' ');
    }

    // Показать правильный ответ
    function showAnswer() {
      const answer = parseAnswer(rounds[currentRoundIndex][currentImageIndex]);
      answerElem.textContent = `${answer}`.toUpperCase();
    }

    // Обработать правильный ответ (Enter)
    function handleCorrect() {
      if (gameEnded || answerShown || !gameStarted) return;
      showAnswer();
      playBeep('positive');
      stopTimer();
      answerShown = true;
      // Пауза 0.5 секунды, затем переход хода
      setTimeout(() => {
        answerShown = false;
        currentImageIndex++;
        // Смена игрока
        activePlayer = activePlayer === 1 ? 2 : 1;
        loadCurrentImage();
        if (!gameEnded) {
          startTimer(activePlayer);
        }
      }, 500);
    }

    // Обработать пропуск (Пробел)
    function handlePass() {
      if (gameEnded || answerShown || !gameStarted) return;
      showAnswer();
      playBeep('negative');
      // Наказание 3 секунды: таймер продолжает тикать, цвет меняется
      const idx = activePlayer - 1;
      timerElems[idx].classList.add('penalty');
      answerShown = true;
      setTimeout(() => {
        timerElems[idx].classList.remove('penalty');
        answerShown = false;
        currentImageIndex++;
        loadCurrentImage();
      }, 3000);
    }

    // Завершить игру
    function endGame() {
      if (gameEnded) return;
      gameEnded = true;
      stopTimer();
      let winner;
      if (timers[0] > timers[1]) {
        winner = 'Игрок 1 победил!';
      } else if (timers[1] > timers[0]) {
        winner = 'Игрок 2 победил!';
      } else {
        winner = 'Ничья!';
      }
      answerElem.textContent = `Игра окончена! ${winner}`;
      // Снять выделение активного игрока
      timerElems.forEach(elem => elem.classList.remove('active'));
    }

    // Слушаем клавиши: Enter — верно, Space — пропуск
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Enter') {
        handleCorrect();
      } else if (e.code === 'Space') {
        e.preventDefault();
        handlePass();
      }
    });

    // Старт игры: данные уже зарегистрированы внешними скриптами
    window.addEventListener('load', () => {
      if (!rounds || !rounds.length) {
        answerElem.textContent = 'Нет данных раундов. Подключите *round.data.js* файлы.';
        return;
      }
      const overlay = document.getElementById('start-overlay');
      const startBtn = document.getElementById('start-btn');
      const countdownEl = document.getElementById('countdown');
      const runCountdown = () => {
        let n = 3;
        startBtn.style.display = 'none';
        countdownEl.style.display = 'block';
        countdownEl.textContent = String(n);
        const id = setInterval(() => {
          n -= 1;
          if (n <= 0) {
            clearInterval(id);
            overlay.style.display = 'none';
            startGame();
          } else {
            countdownEl.textContent = String(n);
          }
        }, 1000);
      };
      startBtn.addEventListener('click', runCountdown, { once: true });
    });
  </script>
</body>
</html>
